#!/bin/bash
# Build the site.

# Include the libraries.
libPath="$(dirname "$0")/lib"
. "$libPath/all.sh"

# Load the config.
. config

# Handle parameters.
for parameter in $@; do
    echo $parameter

    if [ "${1:0:1}" == '-' ]; then
        case $1 in
            '--test')
                echo "Test mode turned on"
                touch "build/.test"
                doTest=1
            ;;
        esac
        shift 1
    fi
done
remaining="$1"

rm -Rf ../intermediate
mkdir -p build
generateMasks
actions src/actions/build-pre
findSubAssets | copySubAssets &
getDocs '' "$remaining" | prepDocs
sortTags
deriveLatest
fillTagCombos
getLists intermediate/tags | buildList intermediate/tags rss intermediate/feed 10
getLists intermediate/tags | buildList intermediate/tags html intermediate/list 100000
getLists intermediate/tagCombos | buildList intermediate/tagCombos html intermediate/list 100000
getLists intermediate/tags | buildRSSFeeds
find intermediate/related -type f | buildDocs
getDocs f "$remaining" | buildDocs
getDocs l "$remaining" | buildDocs
findSymlinks | copySymlinks
actions src/actions/build-post
copyAssets

wait

# TODO Do lowercase symlinks.
